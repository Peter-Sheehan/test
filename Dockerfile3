# Use multi-stage builds to minimize the final image size
FROM python:3.11-slim AS builder

# Set up a working directory
WORKDIR /app

# Install build dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends gcc libffi-dev && \
    rm -rf /var/lib/apt/lists/*

# Copy the requirements file and install packages
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# --------------
# Final stage
FROM python:3.11-slim

# Set up a working directory
WORKDIR /app

# Copy only the necessary files from the builder stage
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin/gunicorn /usr/local/bin/gunicorn

# Copy the application code
COPY . .

# Specify a non-root user
RUN adduser --disabled-password --gecos '' myuser
USER myuser

# Set environment variables
ENV MY_VAR=default_value

# Expose the application's port
EXPOSE 8080

# Use CMD to run the application
CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:8080", "app:app"]