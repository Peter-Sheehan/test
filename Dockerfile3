# Use a specific and minimal base image suitable for Python
FROM python:3.10-slim

# Set environment variable for Python
ENV PYTHONUNBUFFERED=1

# Create a non-root user to enhance security
RUN groupadd -r appuser && useradd -r -g appuser appuser

# Create and set the working directory
WORKDIR /app

# Install necessary system packages with no-install-recommends
# to minimize image size and cleanup afterwards to remove apt cache
RUN apt-get update && \
    apt-get install -y --no-install-recommends gcc libffi-dev && \
    rm -rf /var/lib/apt/lists/*

# Use COPY instead of ADD for better clarity
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application source code
COPY . .

# Change the ownership of the app directory to the non-root user
RUN chown -R appuser:appuser /app

# Switch to the non-root user
USER appuser

# Use an entrypoint script to manage multiple processes
ENTRYPOINT ["gunicorn", "app:app", "--bind", "0.0.0.0:8080"]

# Expose the application port
EXPOSE 8080